const { PREFIX } = require('../../config');
const { onlyNumbers } = require('../../utils');

const rpgData = {};
const ranking = [];
const eventosAtivos = [];

const TITULOS = {
  REI: { nome: "üëë Rei", bonus: 0.25, requisito: 1, imposto: 0.10 },
  RAINHA: { nome: "üë∏ Rainha", bonus: 0.20, requisito: 2, imposto: 0.08 },
  PRINCIPE: { nome: "ü§¥ Pr√≠ncipe", bonus: 0.15, requisito: 3, imposto: 0.05 },
  DUQUE: { nome: "üé© Duque", bonus: 0.12, requisito: 5, imposto: 0.03 },
  NOBRE: { nome: "üíÇ Nobre", bonus: 0.08, requisito: 10, imposto: 0.02 },
  PLEBEU: { nome: "üßë Plebeu", bonus: 0, requisito: Infinity, imposto: 0 },
  ESCRAVO: { nome: "‚õìÔ∏è Escravo", bonus: -0.40, requisito: null, imposto: 0.50 },
  FUGITIVO: { nome: "üèÉ‚Äç‚ôÇÔ∏è Fugitivo", bonus: -0.60, requisito: null, imposto: 0 },
  MONSTRO: { nome: "üëπ Monstro", bonus: -0.75, requisito: null, imposto: 0.70 },
  BRUXO: { nome: "üßô Bruxo", bonus: 0.30, requisito: null, imposto: 0.15 }
};

const EMPREGOS = {
  FAZENDEIRO: {
    nome: "üë®‚Äçüåæ Fazendeiro", emoji: "üë®‚Äçüåæ", cooldown: 10,
    ganho: { min: 15, max: 30 }, xp: 2, risco: 0,
    desc: "Cultiva alimentos para o reino", categoria: "civil"
  },
  MINEIRO: {
    nome: "‚õèÔ∏è Mineiro", emoji: "‚õèÔ∏è", cooldown: 12,
    ganho: { min: 20, max: 40 }, xp: 3, risco: 0.1,
    desc: "Extrai min√©rios preciosos", categoria: "civil"
  },
  PESCADOR: {
    nome: "üé£ Pescador", emoji: "üé£", cooldown: 10,
    ganho: { min: 18, max: 35 }, xp: 2, risco: 0.05,
    desc: "Pesca nos rios do reino", categoria: "civil"
  },
  CAVALEIRO: {
    nome: "‚öîÔ∏è Cavaleiro", emoji: "‚öîÔ∏è", cooldown: 20,
    ganho: { min: 30, max: 60 }, xp: 5, risco: 0.2,
    desc: "Defende o reino em batalhas", categoria: "militar",
    requisito: "NOBRE"
  },
  ARQUEIRO: {
    nome: "üèπ Arqueiro", emoji: "üèπ", cooldown: 15,
    ganho: { min: 25, max: 45 }, xp: 4, risco: 0.15,
    desc: "Atira com precis√£o", categoria: "militar"
  },
  BRUXO: {
    nome: "üîÆ Aprendiz de Bruxo", emoji: "üîÆ", cooldown: 25,
    ganho: { min: 40, max: 80 }, xp: 8, risco: 0.3,
    desc: "Estuda artes arcanas", categoria: "magico"
  },
  LADRAO: {
    nome: "ü¶π Ladr√£o", emoji: "ü¶π", cooldown: 15,
    ganho: { min: 50, max: 90 }, xp: 6, risco: 0.6,
    desc: "Rouba dos ricos e pobres", categoria: "ilegal",
    ilegal: true
  },
  MALDITO: {
    nome: "üíÄ Maldito", emoji: "üíÄ", cooldown: 40,
    ganho: { min: 100, max: 200 }, xp: 15, risco: 0.8,
    desc: "Executa trabalhos amaldi√ßoados", categoria: "maldicao",
    efeito: "maldicao"
  }
};

const MALDICOES = {
  AZAR: {
    nome: "‚ò†Ô∏è Maldi√ß√£o do Azar",
    efeito: (user) => { user.cooldownMultiplier = 1.5; },
    desc: "Seus trabalhos demoram 50% mais tempo"
  },
  SANGUESSUGA: {
    nome: "ü©∏ Maldi√ß√£o Sanguessuga",
    efeito: (user) => { user.goldLoss = 0.1; },
    desc: "Perde 10% do gold diariamente"
  },
  ESCRAVIDAO: {
    nome: "‚õìÔ∏è Maldi√ß√£o da Escravid√£o",
    efeito: (user) => { user.titulo = "ESCRAVO"; },
    desc: "Voc√™ se torna escravo automaticamente"
  }
};

const calcularNivel = (xp) => Math.floor(Math.sqrt(xp / 150)) + 1;
const xpParaProxNivel = (nivel) => Math.pow(nivel, 2) * 150;

const atualizarSistema = () => {
  ranking.length = 0;
  
  Object.entries(rpgData).forEach(([userId, user]) => {
    if(user.maldicoes?.length > 0) {
      user.maldicoes.forEach(maldicao => {
        MALDICOES[maldicao].efeito(user);
      });
    }
    
    if(["ESCRAVO", "MONSTRO"].includes(user.titulo)) {
      const imposto = TITULOS[user.titulo].imposto;
      const perdido = Math.floor(user.gold * imposto);
      user.gold -= perdido;
      
      const rei = ranking.find(u => u.titulo === "REI");
      if(rei) rpgData[rei.userId].gold += perdido;
    }
    
    if(user.gold > 0) ranking.push({ userId, ...user });
  });
  
  ranking.sort((a, b) => b.gold - a.gold);
  
  ranking.forEach((user, index) => {
    if(index === 0) user.titulo = "REI";
    else if(index === 1) user.titulo = "RAINHA";
    else if(index === 2) user.titulo = "PRINCIPE";
    else if(index < 5) user.titulo = "DUQUE";
    else if(index < 15) user.titulo = "NOBRE";
    else if(!["BRUXO", "MONSTRO"].includes(user.titulo)) user.titulo = "PLEBEU";
  });
  
  if(Math.random() < 0.2) {
    const eventos = ["INVASAO_MONSTROS", "FESTA_REAL", "PESTE", "COLHEITA_ABUNDANTE"];
    eventosAtivos.push({ tipo: eventos[Math.floor(Math.random() * eventos.length)], duracao: 3 });
  }
};

// ========== COMANDO PRINCIPAL ==========
module.exports = {
  name: "rpg",
  description: "Sistema RPG completo",
  commands: ["rpg", "trabalhar", "rank", "reinado", "amaldicoar", "curar"],
  usage: `${PREFIX}rpg <comando> [op√ß√µes]`,
  
  handle: async ({ sendText, userJid, args, command, mentionByReply }) => {
    const userId = onlyNumbers(userJid);
    
    if(!rpgData[userId]) {
      rpgData[userId] = {
        gold: 100,
        xp: 0,
        nivel: 1,
        titulo: "PLEBEU",
        cooldowns: {},
        historico: [],
        fugitivo: false,
        maldicoes: [],
        inventario: []
      };
    }
    
    const user = rpgData[userId];
    atualizarSistema();

    // ========== COMANDO: RANK/REINADO ==========
    if(command === "rank" || command === "reinado") {
      if(ranking.length === 0) return await sendText("üè∞ O reino ainda est√° vazio...");
      
      let mensagem = "‚ú® *üèÜ RANKING DO REINO* ‚ú®\n\n";
      ranking.slice(0, 15).forEach((user, index) => {
        const titulo = TITULOS[user.titulo]?.nome || "üßë Plebeu";
        mensagem += `${index + 1}. ${titulo} @${user.userId}\n   üí∞ ${user.gold} golds | üåü Nvl ${user.nivel}`;
        if(user.maldicoes?.length > 0) mensagem += ` | üíÄ ${user.maldicoes.length} maldi√ß√µes`;
        mensagem += "\n";
      });
      
      if(eventosAtivos.length > 0) {
        mensagem += "\n‚ö° *EVENTOS ATIVOS*\n";
        eventosAtivos.forEach(e => mensagem += `- ${e.tipo.replace(/_/g, ' ')} (${e.duracao}d)\n`);
      }
      
      return await sendText(mensagem);
    }

    // ========== COMANDO: AMALDICOAR ==========
    if(command === "amaldicoar" && mentionByReply) {
      if(!["BRUXO", "REI", "RAINHA"].includes(user.titulo)) {
        return await sendText("üö´ *Acesso Negado!* Apenas bruxos e a realeza podem amaldi√ßoar.");
      }
      
      const alvoId = onlyNumbers(mentionByReply);
      if(!rpgData[alvoId]) return await sendText("‚ùå Jogador n√£o encontrado!");
      
      const maldicoes = Object.keys(MALDICOES);
      const maldicao = maldicoes[Math.floor(Math.random() * maldicoes.length)];
      
      if(!rpgData[alvoId].maldicoes) rpgData[alvoId].maldicoes = [];
      rpgData[alvoId].maldicoes.push(maldicao);
      
      return await sendText(
        `üåÄ *MALDI√á√ÉO LAN√áADA!*\n` +
        `üßô ${TITULOS[user.titulo].nome} amaldi√ßoou @${alvoId}\n` +
        `üíÄ *${MALDICOES[maldicao].nome}*\n` +
        `üìú *Efeito:* ${MALDICOES[maldicao].desc}`
      );
    }

    // ========== COMANDO: CURAR ==========
    if(command === "curar" && mentionByReply) {
      if(!["BRUXO", "REI", "RAINHA"].includes(user.titulo)) {
        return await sendText("üö´ *Acesso Negado!* Apenas bruxos e a realeza podem curar.");
      }
      
      const alvoId = onlyNumbers(mentionByReply);
      if(!rpgData[alvoId]?.maldicoes?.length) return await sendText("‚ùå Jogador n√£o est√° amaldi√ßoado!");
      
      const maldicao = rpgData[alvoId].maldicoes.pop();
      return await sendText(
        `‚ú® *MALDI√á√ÉO REMOVIDA!*\n` +
        `üßô ${TITULOS[user.titulo].nome} curou @${alvoId}\n` +
        `üõ°Ô∏è *${MALDICOES[maldicao].nome}* foi removida!`
      );
    }

    // ========== COMANDO: TRABALHAR ==========
    if(command === "trabalhar" || (command === "rpg" && args[0] === "trabalhar")) {
      const empregoArg = args[1]?.toLowerCase();
      
      if(!empregoArg) {
        let mensagem = `üè∞ *üìú LISTA DE EMPREGOS* üè∞\n\n` +
          `üë§ *Seu Status:*\n` +
          `üè∑Ô∏è ${TITULOS[user.titulo].nome} | üí∞ ${user.gold}g | üåü Nvl ${user.nivel}\n\n`;
        
        Object.values(EMPREGOS).forEach(emp => {
          const disponivel = !(emp.requisito && user.titulo !== emp.requisito) && 
                           !(emp.ilegal && ["REI", "RAINHA", "PRINCIPE", "DUQUE"].includes(user.titulo));
          
          mensagem += `${disponivel ? emp.emoji : "üîí"} *${emp.nome}*\n` +
                     `‚è±Ô∏è ${emp.cooldown}s | üí∞ ${emp.ganho.min}-${emp.ganho.max}g | ‚ú® +${emp.xp}xp\n` +
                     `${emp.desc}${!disponivel ? " (üîí Bloqueado)" : ""}\n\n`;
        });
        
        return await sendText(mensagem + `üìå Exemplo: ${PREFIX}trabalhar mineiro`);
      }
      
      const emprego = Object.values(EMPREGOS).find(e => 
        e.nome.toLowerCase().includes(empregoArg)
      );
      
      if(!emprego) return await sendText(`‚ùå Emprego n√£o encontrado! Use ${PREFIX}trabalhar para listar.`);
      
      if(emprego.requisito && user.titulo !== emprego.requisito) {
        return await sendText(`üîí Voc√™ precisa ser ${TITULOS[emprego.requisito].nome} para este trabalho.`);
      }
      
      if(user.fugitivo) {
        if(Math.random() < 0.4) {
          user.titulo = "ESCRAVO";
          user.fugitivo = false;
          return await sendText(`‚õìÔ∏è *CAPTURADO!* Voc√™ foi pego e agora √© um ESCRAVO!`);
        }
        return await sendText(`üèÉ‚Äç‚ôÇÔ∏è *FUGITIVO!* Voc√™ n√£o pode trabalhar enquanto est√° fugindo!`);
      }
      
      const cooldownRestante = (user.cooldowns[emprego.nome] || 0) - Date.now();
      if(cooldownRestante > 0) {
        return await sendText(
          `‚è≥ *AGUARDE* ${Math.ceil(cooldownRestante/1000)}s\n` +
          `Voc√™ pode trabalhar como ${emprego.emoji} ${emprego.nome} novamente em ${Math.ceil(cooldownRestante/1000)} segundos.`
        );
      }
      
      let ganho = Math.floor(Math.random() * (emprego.ganho.max - emprego.ganho.min + 1)) + emprego.ganho.min;
      ganho += ganho * TITULOS[user.titulo].bonus;
      ganho = Math.round(ganho);
      
      if(TITULOS[user.titulo].imposto > 0) {
        const imposto = Math.floor(ganho * TITULOS[user.titulo].imposto);
        ganho -= imposto;
        if(["ESCRAVO", "MONSTRO"].includes(user.titulo)) {
          const rei = ranking.find(u => u.titulo === "REI");
          if(rei) rpgData[rei.userId].gold += imposto;
        }
      }
      
      let evento = "";
      
      if(emprego.ilegal && Math.random() < emprego.risco) {
        user.fugitivo = true;
        evento = `\n\nüö® *ALERTA!* Voc√™ foi descoberto e agora √© um FUGITIVO!`;
      } 
      else if(emprego.efeito === "maldicao" && Math.random() < 0.4) {
        const maldicao = Object.keys(MALDICOES)[Math.floor(Math.random() * Object.keys(MALDICOES).length)];
        if(!user.maldicoes) user.maldicoes = [];
        user.maldicoes.push(maldicao);
        evento = `\n\nüíÄ *MALDI√á√ÉO!* ${MALDICOES[maldicao].nome} - ${MALDICOES[maldicao].desc}`;
      }
      else if(user.titulo === "ESCRAVO" && Math.random() < 0.1) {
        user.titulo = "MONSTRO";
        evento = `\n\nüëπ *TRANSFORMA√á√ÉO!* Voc√™ se tornou um MONSTRO! 70% de impostos para o rei.`;
      }
      else if(user.titulo === "PLEBEU" && Math.random() < 0.05) {
        user.titulo = "NOBRE";
        evento = `\n\nüé© *PROMO√á√ÉO!* Voc√™ agora √© um NOBRE!`;
      }
      else if(emprego.categoria === "magico" && Math.random() < 0.1 && user.nivel >= 5) {
        user.titulo = "BRUXO";
        evento = `\n\nüßô *BRUXO!* Voc√™ dominou as artes arcanas!`;
      }
      
      user.gold += ganho;
      user.xp += emprego.xp;
      user.cooldowns[emprego.nome] = Date.now() + (emprego.cooldown * 1000);
      
      const novoNivel = calcularNivel(user.xp);
      if(novoNivel > user.nivel) {
        evento += `\n\nüéâ *N√çVEL ${novoNivel}!* Seus ganhos aumentaram!`;
        user.nivel = novoNivel;
      }
      
      atualizarSistema();
      
      return await sendText(
        `üíº *TRABALHO CONCLU√çDO* üíº\n\n` +
        `${emprego.emoji} *${emprego.nome}*\n` +
        `üí∞ Ganho: ${ganho}g (${TITULOS[user.titulo].bonus * 100}% ${TITULOS[user.titulo].bonus > 0 ? 'b√¥nus' : 'desconto'})\n` +
        `‚ú® XP: +${emprego.xp} (${user.xp}/${xpParaProxNivel(user.nivel)})\n` +
        `üè∑Ô∏è T√≠tulo: ${TITULOS[user.titulo].nome}\n` +
        `‚è±Ô∏è Recarga: ${emprego.cooldown}s` +
        evento
      );
    }

    // ========== MENSAGEM DE AJUDA PADR√ÉO ==========
    return await sendText(
      `‚ú® *üè∞ SISTEMA RPG DO REINO* ‚ú®\n\n` +
      `üìú *COMANDOS DISPON√çVEIS:*\n\n` +
      `üõ†Ô∏è *${PREFIX}trabalhar* - Lista de empregos\n` +
      `üõ†Ô∏è *${PREFIX}trabalhar <emprego>* - Trabalha\n` +
      `üèÜ *${PREFIX}rank* - Ranking do reino\n` +
      `üåÄ *${PREFIX}amaldicoar @jogador* - Lan√ßa maldi√ß√£o (Bruxos/Realeza)\n` +
      `‚ú® *${PREFIX}curar @jogador* - Remove maldi√ß√£o (Bruxos/Realeza)\n\n` +
      `üí° Dica: Use *${PREFIX}trabalhar* para ver todos os empregos detalhados.`
    );
  }
};
